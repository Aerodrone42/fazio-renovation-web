
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Node.js ‚öôÔ∏è
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies üì¶
        run: npm ci || npm install
        
      - name: Configure Vite for GitHub Pages üîß
        run: |
          # Create or modify .env file for production
          echo "VITE_BASE_URL=\${GITHUB_REPOSITORY#*/}" > .env.production
        
      - name: Build üîß
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Prepare for deployment üìù
        run: |
          # Cr√©er les fichiers n√©cessaires pour GitHub Pages
          touch dist/.nojekyll
          echo "www.sarlfaziolorenzo.fr" > dist/CNAME
          cp public/404.html dist/404.html || echo "No 404.html to copy"
          
          # V√©rifier le contenu des dossiers pour s'assurer que tous les fichiers sont l√†
          echo "Contenu du dossier dist avant modification:"
          ls -la dist/
          
          echo "Contenu du dossier dist/assets (s'il existe):"
          ls -la dist/assets/ || echo "Le dossier assets n'existe pas"
          
          # Modifier les chemins relatifs pour s'assurer qu'ils sont corrects pour GitHub Pages
          sed -i 's|src="/|src="./|g' dist/index.html || echo "No replacement needed for src paths"
          sed -i 's|href="/|href="./|g' dist/index.html || echo "No replacement needed for href paths"
          
          # Remplacer src="./src/main.tsx" par le chemin correct vers le bundle JS g√©n√©r√©
          if grep -q 'src="./src/main.tsx"' dist/index.html; then
            if [ -f dist/assets/main.js ]; then
              sed -i 's|src="./src/main.tsx"|src="./assets/main.js"|g' dist/index.html
            elif [ -f dist/assets/index.js ]; then
              sed -i 's|src="./src/main.tsx"|src="./assets/index.js"|g' dist/index.html
            fi
          fi
          
          # V√©rifier si le fichier main.js ou index.js existe, sinon cr√©er un fichier de secours
          if [ ! -f dist/assets/main.js ] && [ ! -f dist/assets/index.js ]; then
            echo "WARNING: main.js et index.js non trouv√©s dans assets. Cr√©ation d'un script de secours."
            mkdir -p dist/assets
            echo "console.log('Script de secours charg√©. Tentative d\'initialisation de l\'application...');" > dist/assets/index.js
            
            # Mettre √† jour l'index.html pour utiliser ce script de secours
            sed -i 's|src="./src/main.tsx"|src="./assets/index.js"|g' dist/index.html
          fi
          
          # Ajouter un script pour rediriger vers l'index.html en cas d'erreur 404
          cat > dist/404.html << EOL
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Redirection vers l'accueil</title>
  <script>
    window.location.href = '/';
  </script>
</head>
<body>
  <p>Redirection vers la page d'accueil...</p>
</body>
</html>
EOL
          
      - name: Verify build files üîç
        run: |
          echo "V√©rification des fichiers g√©n√©r√©s:"
          ls -la dist/
          echo "Contenu du dossier assets:"
          ls -la dist/assets/ || echo "Le dossier assets n'existe pas"
          
          echo "Contenu de l'index.html apr√®s modifications:"
          cat dist/index.html
          
      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          clean: true
