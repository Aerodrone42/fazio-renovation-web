
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Node.js ‚öôÔ∏è
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies üì¶
        run: npm ci || npm install
        
      - name: Create critical directories and files ‚öôÔ∏è
        run: |
          echo "Cr√©ation des dossiers et fichiers critiques..."
          mkdir -p docs/assets
          
          # Cr√©er un index.js fonctionnel
          cat > docs/assets/index.js << 'EOL'
import React from 'react';
import { createRoot } from 'react-dom/client';

// Import dynamique du composant App avec gestion d'erreur
const loadApp = async () => {
  try {
    // Tentative d'import du composant App depuis diff√©rents chemins possibles
    let App;
    try {
      const module = await import('./App.jsx');
      App = module.default;
    } catch (e) {
      console.warn("√âchec du chargement depuis ./App.jsx, tentative avec ./App.js");
      try {
        const module = await import('./App.js');
        App = module.default;
      } catch (e2) {
        console.warn("√âchec du chargement depuis ./App.js, tentative directe");
        // Composant de secours minimal
        App = () => React.createElement('div', null, 'Application en cours de chargement...');
      }
    }

    // Monter l'application dans le DOM
    const rootElement = document.getElementById('root');
    if (rootElement) {
      createRoot(rootElement).render(React.createElement(App));
      console.log('Application charg√©e avec succ√®s');
    } else {
      throw new Error('√âl√©ment root non trouv√©');
    }
  } catch (error) {
    console.error('Erreur fatale lors du chargement:', error);
    document.body.innerHTML = '<div style="padding:20px;"><h1>Erreur de chargement</h1><p>Impossible de charger l\'application. Veuillez r√©essayer plus tard.</p></div>';
  }
};

// Ex√©cuter le chargement
loadApp();
EOL
          
          # Autres fichiers n√©cessaires
          echo "www.sarlfaziolorenzo.fr" > docs/CNAME
          touch docs/.nojekyll
          echo "Fichiers cr√©√©s avec succ√®s."
          
          # V√©rifier la pr√©sence des fichiers
          ls -la docs/
          ls -la docs/assets/
          
      - name: Build üîß
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Post-build file verification and fixes üîç
        run: |
          echo "V√©rification post-build des fichiers critiques..."
          
          # V√©rifier et copier index.js s'il manque
          if [ ! -f "docs/assets/index.js" ] || [ ! -s "docs/assets/index.js" ]; then
            echo "ATTENTION: index.js manquant ou vide dans docs/assets/"
            
            # Cr√©er un index.js de secours si n√©cessaire
            echo "Cr√©ation d'un index.js de secours..."
            cat > docs/assets/index.js << 'EOL'
import React from 'react';
import { createRoot } from 'react-dom/client';

// Composant App de secours minimal
const App = () => {
  return React.createElement('div', { 
    style: { 
      padding: '20px',
      fontFamily: 'sans-serif',
      maxWidth: '600px',
      margin: '0 auto',
      textAlign: 'center'
    } 
  }, [
    React.createElement('h1', { key: 'title' }, 'SARL FAZIO Lorenzo'),
    React.createElement('p', { key: 'desc' }, 'Sp√©cialiste du carrelage et de la r√©novation'),
    React.createElement('p', { key: 'info' }, 'Le site est en cours de chargement, veuillez patienter ou rafra√Æchir la page.')
  ]);
};

// Fonction d'initialisation
const init = () => {
  try {
    const rootElement = document.getElementById('root');
    if (rootElement) {
      createRoot(rootElement).render(React.createElement(App));
      console.log('Application de secours charg√©e');
    }
  } catch (e) {
    console.error('Erreur lors du chargement de secours:', e);
    document.body.innerHTML = '<div style="padding:20px;text-align:center;"><h1>SARL FAZIO Lorenzo</h1><p>Sp√©cialiste du carrelage et de la r√©novation</p><p>Une erreur est survenue. Veuillez r√©essayer plus tard.</p></div>';
  }
};

// Ex√©cuter l'initialisation
init();
EOL
          fi
          
          # S'assurer que index.html existe
          if [ ! -f "docs/index.html" ]; then
            echo "ATTENTION: index.html manquant dans docs/"
            cp index.html docs/index.html || echo "√âchec de la copie de index.html"
          fi
          
          # V√©rifier √† nouveau les fichiers
          echo "V√©rification finale des fichiers:"
          ls -la docs/
          ls -la docs/assets/
          
      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs
          branch: gh-pages
          clean: false
