
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Node.js ‚öôÔ∏è
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies üì¶
        run: npm ci || npm install
        
      - name: Create assets directory and index.js üìÅ
        run: |
          mkdir -p docs/assets
          echo "// Fichier index.js minimal de secours" > docs/assets/index.js
          echo "Assets directory and index.js created before build"
        
      - name: Build üîß
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: Debug information üß™
        run: |
          echo "Contents of docs directory:"
          ls -la docs/
          echo ""
          echo "Contents of docs/assets directory:"
          ls -la docs/assets/
          
      - name: Force create index.js if missing ‚ö†Ô∏è
        run: |
          if [ ! -f "docs/assets/index.js" ] || [ ! -s "docs/assets/index.js" ]; then
            echo "‚ö†Ô∏è index.js manquant ou vide dans docs/assets - Cr√©ation d'un fichier de secours"
            cat > docs/assets/index.js << 'EOL'
import { createRoot } from 'react-dom/client';
import React from 'react';
import App from '../src/App.js';

try {
  const rootElement = document.getElementById('root');
  if (rootElement) {
    createRoot(rootElement).render(React.createElement(App));
    console.log("Application charg√©e via index.js de secours");
  }
} catch (e) {
  console.error("Erreur lors du chargement:", e);
  document.getElementById('root').innerHTML = '<div style="padding:20px;"><h1>Erreur de chargement</h1><p>Impossible de charger l\'application.</p></div>';
}
EOL
            echo "‚úÖ index.js de secours cr√©√© avec succ√®s!"
          else
            echo "‚úÖ index.js existe dans docs/assets/"
          fi
          
      - name: Ensure directories and files exist üìã
        run: |
          echo "www.sarlfaziolorenzo.fr" > docs/CNAME
          touch docs/.nojekyll
          
          # Copier 404.html vers docs
          cp public/404.html docs/404.html || echo "‚ùå Failed to copy 404.html"
          
          # S'assurer que le script gptengineer est pr√©sent dans index.html
          if ! grep -q "gptengineer.js" docs/index.html; then
            sed -i 's|<head>|<head>\n    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>|' docs/index.html
          fi
          
      - name: Update index.html with direct script tag üìÑ
        run: |
          cat > docs/index.html << 'EOL'
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SARL FAZIO Lorenzo | Carrelage & r√©novation dans l'Ouest Lyonnais et l'Ain</title>
    <meta name="description" content="SARL FAZIO Lorenzo - Sp√©cialiste du carrelage, mosa√Øque, pierre naturelle, douches √† l'italienne et r√©novation de salles de bain cl√© en main dans l'Ouest Lyonnais et l'Ain." />
    <meta name="author" content="SARL FAZIO Lorenzo" />
    <meta property="og:title" content="SARL FAZIO Lorenzo | Carrelage & r√©novation" />
    <meta property="og:description" content="Sp√©cialiste du carrelage et de la r√©novation cl√© en main dans l'Ouest Lyonnais et l'Ain." />
    <meta property="og:type" content="website" />
    
    <!-- Favicon avec chemin relatif -->
    <link rel="icon" type="image/png" href="./lovable-uploads/8d86e4df-9559-4d2e-a51e-e1ca7622720d.png">
    
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap">
    
    <!-- Script for GPT Engineer - Important pour la fonctionnalit√© de s√©lection -->
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Script de chargement direct -->
    <script type="module" src="./assets/index.js"></script>
    
    <!-- Script de diagnostic -->
    <script>
      window.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded event fired");
        const rootElement = document.getElementById('root');
        
        // V√©rifier si l'application React est charg√©e apr√®s un d√©lai
        setTimeout(function() {
          if (rootElement && rootElement.children.length === 0) {
            console.error("L'application React ne semble pas s'√™tre charg√©e.");
            rootElement.innerHTML = '<div style="padding:20px;text-align:center;font-family:sans-serif;"><h2>Chargement en cours...</h2><p>Si cette page persiste, veuillez rafra√Æchir.</p></div>';
            
            // Tentative de chargement alternatif
            const script = document.createElement('script');
            script.type = 'module';
            script.src = '/assets/index.js';  // Chemin alternatif
            document.body.appendChild(script);
          }
        }, 2000);
      });
    </script>
  </body>
</html>
EOL
          echo "‚úÖ index.html mis √† jour avec un script de chargement direct"
          
      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs
          branch: gh-pages
          clean: false  # Pour √©viter de supprimer des fichiers importants
